name: Build InfusePlus from Source (iOS 26.2 Fixed)

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: "URL to the decrypted IPA file"
        default: ""
        required: true
        type: string
      display_name:
        description: "App Name (Optional)"
        default: "Infuse"
        required: true
        type: string
      bundle_id:
        description: "BundleID (Optional)"
        default: "com.firecore.infuse"
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build and Package
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1
        with:
          path: main
          submodules: recursive

      - name: Hide Sensitive Inputs
        uses: levibostian/action-hide-sensitive-inputs@v1
        with:
          exclude_inputs: display_name,bundle_id

      - name: Validate IPA URL
        run: |
          if [ -z "${{ inputs.ipa_url }}" ]; then
            echo "::warning::No ipa_url provided. You can still run a build to produce a .deb."
          else
            curl -L -r 0-1023 -o sample.part "${{ inputs.ipa_url }}" > /dev/null 2>&1 || true
            if [ -f sample.part ]; then
              file_type=$(file --mime-type -b sample.part)
              if [[ "$file_type" != "application/x-ios-app" && "$file_type" != "application/zip" ]]; then
                echo "::error::Validation failed: The file is not a valid IPA file. Detected type: $file_type."
                rm sample.part || true
                exit 1
              fi
              rm sample.part
            fi
          fi

      - name: Install Build Dependencies (including pipx via Homebrew)
        run: |
          brew update || true
          # Install tools needed for building and packaging
          brew install make ldid dpkg wget unzip pipx || true
          # Ensure GNU make is in PATH (theos expects 'make' but Homebrew provides 'gmake' caveat)
          echo "$(brew --prefix make)/libexec/gnubin" >> $GITHUB_PATH
          # Ensure Homebrew binaries are in PATH for subsequent steps
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
          # Ensure pipx shims location will be in PATH later
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Setup THEOS and iOS SDK
        run: |
          export THEOS=$HOME/theos
          echo "THEOS=$THEOS" >> $GITHUB_ENV
          if [ -d "$THEOS" ]; then
            echo "Using existing THEOS at $THEOS"
          else
            git clone --recursive https://github.com/theos/theos.git "$THEOS"
          fi

          # Download iOS SDK collection for Theos if not present
          if [ ! -d "$THEOS/sdks" ] || [ -z "$(ls -A $THEOS/sdks 2>/dev/null)" ]; then
            curl -LO https://github.com/theos/sdks/archive/master.zip
            unzip -q master.zip
            mkdir -p "$THEOS/sdks"
            mv sdks-master/* "$THEOS/sdks/"
            rm -rf sdks-master master.zip
          else
            echo "Theos sdks already present"
          fi

      - name: Install pyzule (cyan) via pipx and verify
        run: |
          # Make sure pipx command is available (installed by brew)
          if ! command -v pipx >/dev/null 2>&1; then
            echo "::error::pipx not found even after brew install. PATH: $PATH"
            echo "Contents of /opt/homebrew/bin:"
            ls -la /opt/homebrew/bin || true
            exit 1
          fi

          # Ensure pipx path setup (creates shims in ~/.local/bin)
          pipx ensurepath || true
          # Ensure ~/.local/bin is in PATH for this step
          export PATH="$HOME/.local/bin:/opt/homebrew/bin:$PATH"

          # Install pyzule (which provides 'cyan') via pipx
          pipx install --force https://github.com/asdfzxcvbn/pyzule-rw/archive/main.zip || true

          # Verify cyan is available
          if ! command -v cyan >/dev/null 2>&1; then
            echo "::error::cyan binary not found after pipx install. PATH: $PATH"
            echo "Listing $HOME/.local/bin:"
            ls -la "$HOME/.local/bin" || true
            echo "Listing /opt/homebrew/bin for cyan:"
            ls -la /opt/homebrew/bin | grep cyan || true
            exit 1
          fi

          cyan --version || true
          echo "cyan installed and available"

      - name: Ensure packaging metadata exists and Build Tweak from Source
        working-directory: main
        run: |
          export THEOS=$HOME/theos
          echo "THEOS=$THEOS" >> $GITHUB_ENV

          # Ensure control file exists where make will look (main/ or main/layout/DEBIAN/)
          if [ ! -f ./control ] && [ ! -f ./layout/DEBIAN/control ]; then
            mkdir -p ./layout/DEBIAN
            cat > ./layout/DEBIAN/control <<'CONTROL_EOF'
Package: com.xdjacobdx.infuseplus
Name: InfusePlus
Version: 0.0.1-1
Section: Tweaks
Priority: optional
Architecture: iphoneos-arm64
Maintainer: Jacob Monroe <youremail@example.com>
Depends: mobilesubstrate (>= 0)
Provides: infuseplus
Description: InfusePlus — tweak to alter Infuse video playback. Built from XDJacobDX/InfusePlus.
CONTROL_EOF
            echo "Created layout/DEBIAN/control"
          else
            echo "control already exists"
          fi

          # Ensure Filter.plist exists (Theos / MobileSubstrate needs this at staging)
          if [ ! -f ./Filter.plist ] && [ ! -f ./InfusePlus.plist ]; then
            cat > ./Filter.plist <<FILTER_EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Filter</key>
  <dict>
    <key>Bundles</key>
    <array>
      <string>${{ inputs.bundle_id }}</string>
    </array>
    <key>Executables</key>
    <array>
      <string>${{ inputs.display_name }}</string>
    </array>
    <key>Mode</key>
    <string>Any</string>
  </dict>
</dict>
</plist>
FILTER_EOF
            echo "Created Filter.plist"
          else
            echo "Filter.plist exists"
          fi

          # Debug listing so logs show what is present
          echo "Files in main/ before build:"
          ls -la

          # Clean and build with Theos
          make clean || true
          make package FINALPACKAGE=1

          echo "Build complete! Listing packages directory:"
          ls -la packages/ || true

      - name: Extract Built DEB
        working-directory: main
        run: |
          mkdir -p tweak_output
          DEB_FILE=$(find packages -name "*.deb" | head -n 1 || true)
          if [ -z "$DEB_FILE" ]; then
            echo "::error::No .deb file found in packages/ — build likely failed before packaging."
            ls -la packages || true
            exit 1
          fi
          echo "Found DEB: $DEB_FILE"
          dpkg-deb -x "$DEB_FILE" tweak_output/
          DYLIB=$(find tweak_output -name "*.dylib" | head -n 1 || true)
          if [ -z "$DYLIB" ]; then
            echo "::error::No .dylib found in extracted DEB"
            find tweak_output -maxdepth 4 -type f -print || true
            exit 1
          fi
          echo "Found dylib: $DYLIB"
          echo "DYLIB_PATH=$DYLIB" >> $GITHUB_ENV

          # Copy bundle if present in project root also (some repos include it)
          if [ -d "InfusePlus.bundle" ]; then
            cp -r InfusePlus.bundle tweak_output/ || true
            echo "Copied InfusePlus.bundle into tweak_output/"
          fi

      - name: Download Decrypted IPA (if provided)
        run: |
          if [ -z "${{ inputs.ipa_url }}" ]; then
            echo "No ipa_url provided; skipping IPA download and injection steps."
            exit 0
          fi
          wget "${{ inputs.ipa_url }}" --no-verbose -O infuse.ipa || true
          if [ ! -f "infuse.ipa" ]; then
            echo "::error::Failed to download IPA"
            ls -lah
            exit 1
          fi
          echo "IPA downloaded successfully"
          ls -lh infuse.ipa

      - name: Create fake DEB & Inject Fixed Tweak into IPA
        if: ${{ inputs.ipa_url != '' }}
        run: |
          # Ensure DYLIB_PATH available
          if [ -z "${{ env.DYLIB_PATH }}" ]; then
            echo "::error::DYLIB_PATH not set. Extraction step may have failed."
            exit 1
          fi

          mkdir -p fake_deb/Library/MobileSubstrate/DynamicLibraries
          cp "${{ env.DYLIB_PATH }}" fake_deb/Library/MobileSubstrate/DynamicLibraries/ || true

          if [ -d "main/tweak_output/InfusePlus.bundle" ]; then
            cp -r main/tweak_output/InfusePlus.bundle fake_deb/Library/MobileSubstrate/DynamicLibraries/ || true
          elif [ -d "main/InfusePlus.bundle" ]; then
            cp -r main/InfusePlus.bundle fake_deb/Library/MobileSubstrate/DynamicLibraries/ || true
          fi

          mkdir -p fake_deb/DEBIAN
          cat > fake_deb/DEBIAN/control <<'DEBCTR'
Package: com.infuseplus.fixed
Name: InfusePlus Fixed
Version: 1.0.0
Architecture: iphoneos-arm64
Maintainer: GitHub Actions
Description: Temporary package containing InfusePlus tweak artifacts for injection
Section: Tweaks
DEBCTR

          dpkg-deb -b fake_deb infuseplus_fixed.deb || true

          # Ensure cyan is in PATH (pipx shims live in ~/.local/bin)
          export PATH="$HOME/.local/bin:/opt/homebrew/bin:$PATH"

          cyan -i infuse.ipa \
               -o InfusePlus_Fixed_iOS26.ipa \
               -uwef infuseplus_fixed.deb \
               -n "${{ inputs.display_name }}" \
               -b "${{ inputs.bundle_id }}" || true

          if [ ! -f "InfusePlus_Fixed_iOS26.ipa" ]; then
            echo "::error::Failed to create final IPA with cyan"
            ls -la
            exit 1
          fi
          echo "Final IPA created successfully!"
          ls -lh InfusePlus_Fixed_iOS26.ipa

      - name: Upload to GitHub Releases
        if: ${{ inputs.ipa_url != '' }}
        uses: softprops/action-gh-release@v2.0.1
        with:
          name: "InfusePlus Fixed - iOS 26.2 (Build ${{ github.run_number }})"
          tag_name: "fixed-build-${{ github.run_number }}"
          files: InfusePlus_Fixed_iOS26.ipa
          draft: false
          body: |
            ## ✅ InfusePlus - iOS 26.2 Compatible Build

            **Build Number:** ${{ github.run_number }}
            **Built from source** using the fixed `Tweak.x` in this repository

            ### What's Fixed:
            - ✅ **transitionDidFinish crash** - No more SIGABRT on video playback
            - ✅ **Black screen fix** - Videos play properly now
            - ✅ **Premium features** - All pro features unlocked
            - ✅ **Background playback** - Enabled by default
            - ✅ **Ad removal** - All ads blocked
            - ✅ **iOS 26.2 compatible** - Built for modern iOS

            ### Technical Details:
            - **Bundle ID:** ${{ inputs.bundle_id }}
            - **Display Name:** ${{ inputs.display_name }}
            - **Architecture:** arm64, arm64e

      - name: Output Release URL
        run: |
          echo "::notice::✅ Build step finished. Check Actions and Releases for artifacts and logs."
