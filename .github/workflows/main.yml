name: Build InfusePlus from Source (iOS 26.2 Fixed)

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: "URL to the decrypted IPA file"
        default: ""
        required: true
        type: string
      display_name:
        description: "App Name (Optional)"
        default: "Infuse"
        required: true
        type: string
      bundle_id:
        description: "BundleID (Optional)"
        default: "com.firecore.infuse"
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build and Package
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: main
          submodules: recursive

      - name: Hide Sensitive Inputs
        uses: levibostian/action-hide-sensitive-inputs@v1
        with:
          exclude_inputs: display_name,bundle_id

      - name: Validate IPA URL
        run: |
          if [ -z "${{ inputs.ipa_url }}" ]; then
            echo "::warning::No ipa_url provided. Workflow will build .deb only."
            exit 0
          fi
          
          # Download first 1KB to check file signature
          curl -L -r 0-1023 -o sample.part "${{ inputs.ipa_url }}"
          
          if [ -f sample.part ]; then
            file_type=$(file --mime-type -b sample.part)
            rm -f sample.part
            # Allow zip, x-ios-app, or octet-stream (common for some hosting)
            if [[ "$file_type" != "application/x-ios-app" && "$file_type" != "application/zip" && "$file_type" != "application/octet-stream" ]]; then
              echo "::error::Validation failed: The file is not a valid IPA. Detected type: $file_type"
              exit 1
            fi
          else
            echo "::warning::Could not download sample from IPA URL; continuing (runner network may block partial range)."
          fi

      - name: Install System Dependencies
        run: |
          brew update
          # Install pipx via brew to avoid PEP 668 errors
          brew install make ldid dpkg wget unzip pipx
          
          # Add Homebrew and pipx bin paths to GITHUB_PATH for subsequent steps
          echo "$(brew --prefix make)/libexec/gnubin" >> $GITHUB_PATH
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Setup Theos
        run: |
          export THEOS="$HOME/theos"
          echo "THEOS=$THEOS" >> $GITHUB_ENV
          
          if [ -d "$THEOS" ]; then
            echo "Using existing THEOS at $THEOS"
          else
            git clone --recursive https://github.com/theos/theos.git "$THEOS"
          fi

          if [ ! -d "$THEOS/sdks" ] || [ -z "$(ls -A $THEOS/sdks 2>/dev/null)" ]; then
            echo "Downloading iOS SDKs..."
            curl -L -o sdks.zip https://github.com/theos/sdks/archive/master.zip
            unzip -q sdks.zip
            mkdir -p "$THEOS/sdks"
            mv sdks-master/* "$THEOS/sdks/"
            rm -rf sdks-master sdks.zip
          else
            echo "Theos SDKs already present"
          fi

      - name: Install Pyzule (Cyan)
        run: |
          # Ensure pipx paths are set up
          pipx ensurepath
          export PATH="$HOME/.local/bin:$PATH"
          
          # Install pyzule
          pipx install --force https://github.com/asdfzxcvbn/pyzule-rw/archive/main.zip
          
          # Verify cyan
          if ! command -v cyan >/dev/null 2>&1; then
            echo "::error::cyan not found after install."
            ls -la "$HOME/.local/bin"
            exit 1
          fi
          echo "Pyzule (Cyan) installed successfully."

      - name: Build Tweak
        working-directory: main
        run: |
          export THEOS="$HOME/theos"
          
          # 1. Create Control File
          if [ ! -f ./layout/DEBIAN/control ]; then
            mkdir -p ./layout/DEBIAN
            cat > ./layout/DEBIAN/control <<'CONTROL_EOF'
          Package: com.xdjacobdx.infuseplus
          Name: InfusePlus
          Version: 0.0.1-1
          Section: Tweaks
          Priority: optional
          Architecture: iphoneos-arm64
          Maintainer: GitHub Actions
          Depends: mobilesubstrate (>= 0)
          Provides: infuseplus
          Description: InfusePlus â€” tweak to alter Infuse video playback.
          CONTROL_EOF
            echo "Created layout/DEBIAN/control"
          fi

          # 2. Create Filter.plist
          if [ ! -f ./Filter.plist ]; then
            cat > ./Filter.plist <<FILTER_EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>Filter</key>
            <dict>
              <key>Bundles</key>
              <array>
                <string>${{ inputs.bundle_id }}</string>
              </array>
              <key>Executables</key>
              <array>
                <string>${{ inputs.display_name }}</string>
              </array>
            </dict>
          </dict>
          </plist>
          FILTER_EOF
          fi

          # 3. Compile
          echo "Starting Build..."
          make clean
          make package FINALPACKAGE=1

      - name: Prepare Injection Artifacts
        working-directory: main
        run: |
          mkdir -p tweak_output
          DEB_FILE=$(find packages -name "*.deb" | head -n 1)
          
          if [ -z "$DEB_FILE" ]; then
            echo "::error::No .deb file found. Build failed."
            exit 1
          fi
          
          echo "Extracting DEB: $DEB_FILE"
          dpkg-deb -x "$DEB_FILE" tweak_output/
          
          DYLIB=$(find tweak_output -name "*.dylib" | head -n 1)
          if [ -z "$DYLIB" ]; then
            echo "::error::No .dylib found in extracted DEB."
            exit 1
          fi
          
          # Export path for next steps
          echo "DYLIB_PATH=$DYLIB" >> $GITHUB_ENV
          echo "Found Dylib: $DYLIB"

      - name: Download and Patch IPA
        if: ${{ inputs.ipa_url != '' }}
        run: |
          # 1. Download (Quietly)
          wget --no-verbose "${{ inputs.ipa_url }}" -O infuse.ipa
          
          if [ ! -f infuse.ipa ]; then
            echo "::error::Failed to download IPA"
            exit 1
          fi

          # 2. Prepare Fake DEB for Cyan
          FULL_DYLIB_PATH="main/${{ env.DYLIB_PATH }}"
          
          mkdir -p fake_deb/Library/MobileSubstrate/DynamicLibraries
          cp "$FULL_DYLIB_PATH" fake_deb/Library/MobileSubstrate/DynamicLibraries/

          # Check for bundle
          if [ -d "main/tweak_output/InfusePlus.bundle" ]; then
            cp -r "main/tweak_output/InfusePlus.bundle" fake_deb/Library/MobileSubstrate/DynamicLibraries/
          elif [ -d "main/InfusePlus.bundle" ]; then
            cp -r "main/InfusePlus.bundle" fake_deb/Library/MobileSubstrate/DynamicLibraries/
          fi

          # Create Fake Control
          mkdir -p fake_deb/DEBIAN
          cat > fake_deb/DEBIAN/control <<'DEB_CTR'
          Package: com.infuseplus.fixed
          Name: InfusePlus Fixed
          Version: 1.0.0
          Architecture: iphoneos-arm64
          Maintainer: GitHub Actions
          Description: Injection Package
          Section: Tweaks
          DEB_CTR

          dpkg-deb -b fake_deb infuseplus_fixed.deb

          # 3. Inject
          # Add cyan to PATH manually for this shell
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "Injecting..."
          # Flags explanation:
          # -u: Remove UISupportedDevices
          # -w: Remove Watch App
          # -e: Remove Extensions
          # -f: File to inject (must come immediately before the file name)
          cyan -i infuse.ipa \
               -o InfusePlus_Fixed.ipa \
               -u -w -e \
               -f infuseplus_fixed.deb \
               -n "${{ inputs.display_name }}" \
               -b "${{ inputs.bundle_id }}"

          if [ ! -f InfusePlus_Fixed.ipa ]; then
            echo "::error::Cyan failed to create IPA"
            exit 1
          fi
          echo "Success: InfusePlus_Fixed.ipa created."

      - name: Upload to Releases
        if: ${{ inputs.ipa_url != '' }}
        uses: softprops/action-gh-release@v2
        with:
          name: "InfusePlus Fixed - iOS 26.2 (Build ${{ github.run_number }})"
          tag_name: "build-${{ github.run_number }}"
          files: InfusePlus_Fixed.ipa
          draft: false
          body: |
            ## InfusePlus Build ${{ github.run_number }}
            **Bundle ID:** ${{ inputs.bundle_id }}
            **Status:** iOS 26.2 Fix Applied
