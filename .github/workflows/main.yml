name: Build InfusePlus from Source (iOS 26.2 Fixed)

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: "URL to the decrypted IPA file"
        default: ""
        required: true
        type: string
      display_name:
        description: "App Name (Optional)"
        default: "Infuse"
        required: true
        type: string
      bundle_id:
        description: "BundleID (Optional)"
        default: "com.firecore.infuse"
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build and Package
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: main
          submodules: recursive

      - name: Hide Sensitive Inputs
        uses: levibostian/action-hide-sensitive-inputs@v1
        with:
          exclude_inputs: display_name,bundle_id

      - name: Validate IPA URL
        run: |
          if [ -z "${{ inputs.ipa_url }}" ]; then
            echo "::warning::No ipa_url provided. You can still run a build to produce a .deb, but no IPA will be generated."
          else
            # Download first 1KB to check file signature
            curl -L -r 0-1023 -o sample.part "${{ inputs.ipa_url }}" > /dev/null 2>&1 || true
            if [ -f sample.part ]; then
              file_type=$(file --mime-type -b sample.part)
              # Check for zip (IPA is a zip) or octet-stream (common for direct downloads)
              if [[ "$file_type" != "application/x-ios-app" && "$file_type" != "application/zip" && "$file_type" != "application/octet-stream" ]]; then
                echo "::error::Validation failed: The file is not a valid IPA/Zip file. Detected type: $file_type."
                rm sample.part || true
                exit 1
              fi
              rm sample.part
            fi
          fi

      - name: Install Build Dependencies
        run: |
          brew update
          brew install make ldid dpkg wget unzip

      - name: Set PATH for GNU Make
        run: echo "$(brew --prefix make)/libexec/gnubin" >> $GITHUB_PATH

      - name: Setup Theos
        run: |
          export THEOS=$HOME/theos
          echo "THEOS=$THEOS" >> $GITHUB_ENV
          
          if [ -d "$THEOS" ]; then
            echo "Using existing THEOS at $THEOS"
          else
            git clone --recursive https://github.com/theos/theos.git "$THEOS"
          fi

          # Download iOS SDK collection for Theos if not present
          if [ ! -d "$THEOS/sdks" ] || [ -z "$(ls -A $THEOS/sdks 2>/dev/null)" ]; then
            echo "Downloading iOS SDKs..."
            curl -L https://github.com/theos/sdks/archive/master.zip -o sdks.zip
            unzip -q sdks.zip
            mkdir -p "$THEOS/sdks"
            mv sdks-master/* "$THEOS/sdks/"
            rm -rf sdks-master sdks.zip
          else
            echo "Theos sdks already present"
          fi

      - name: Install Pyzule (Cyan)
        run: |
          python3 -m pip install --upgrade --user pipx
          python3 -m pipx ensurepath
          
          # Manually add pipx bin to PATH for this session
          export PATH="$HOME/.local/bin:$PATH"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # Install pyzule (force to ensure clean install on runner)
          pipx install --force https://github.com/asdfzxcvbn/pyzule-rw/archive/main.zip

      - name: Build Tweak
        working-directory: main
        run: |
          export THEOS=$HOME/theos
          
          # 1. Ensure control file exists
          if [ ! -f ./layout/DEBIAN/control ]; then
            mkdir -p ./layout/DEBIAN
            cat > ./layout/DEBIAN/control <<'CONTROL_EOF'
          Package: com.xdjacobdx.infuseplus
          Name: InfusePlus
          Version: 0.0.1-1
          Section: Tweaks
          Priority: optional
          Architecture: iphoneos-arm64
          Maintainer: GitHub Actions
          Depends: mobilesubstrate (>= 0)
          Provides: infuseplus
          Description: InfusePlus â€” tweak to alter Infuse video playback.
          CONTROL_EOF
            echo "Created layout/DEBIAN/control"
          fi

          # 2. Ensure Filter.plist exists
          if [ ! -f ./layout/DEBIAN/com.xdjacobdx.infuseplus.plist ]; then
            # Note: Theos usually handles filters via the Makefile, but if manually placing:
            cat > ./Filter.plist <<FILTER_EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>Filter</key>
            <dict>
              <key>Bundles</key>
              <array>
                <string>${{ inputs.bundle_id }}</string>
              </array>
            </dict>
          </dict>
          </plist>
          FILTER_EOF
          fi

          # 3. Build
          make clean
          make package FINALPACKAGE=1

      - name: Prepare Injection Artifacts
        id: prepare_artifacts
        working-directory: main
        run: |
          mkdir -p tweak_output
          
          # Find the built DEB
          DEB_FILE=$(find packages -name "*.deb" | head -n 1)
          if [ -z "$DEB_FILE" ]; then
            echo "::error::Build failed: No .deb file found in packages/"
            exit 1
          fi
          
          echo "Extracting $DEB_FILE..."
          dpkg-deb -x "$DEB_FILE" tweak_output/
          
          # Find the Dylib
          DYLIB=$(find tweak_output -name "*.dylib" | head -n 1)
          if [ -z "$DYLIB" ]; then
            echo "::error::Extraction failed: No .dylib found."
            exit 1
          fi
          
          echo "DYLIB_PATH=$DYLIB" >> $GITHUB_ENV
          echo "Dylib found at: $DYLIB"

      - name: Download and Patch IPA
        if: ${{ inputs.ipa_url != '' }}
        run: |
          # 1. Download IPA
          echo "Downloading IPA..."
          wget "${{ inputs.ipa_url }}" --no-verbose -O infuse.ipa
          
          if [ ! -f "infuse.ipa" ]; then
            echo "::error::Failed to download IPA."
            exit 1
          fi

          # 2. Prepare Fake DEB structure for Cyan
          # We need to construct a specific folder structure for Cyan to inject
          mkdir -p fake_deb/Library/MobileSubstrate/DynamicLibraries
          
          # Copy Dylib (Variable set in previous step points to main/tweak_output/...)
          cp "main/${{ env.DYLIB_PATH }}" fake_deb/Library/MobileSubstrate/DynamicLibraries/
          
          # Copy Bundle (Check multiple locations)
          if [ -d "main/tweak_output/InfusePlus.bundle" ]; then
            cp -r "main/tweak_output/InfusePlus.bundle" fake_deb/Library/MobileSubstrate/DynamicLibraries/
          elif [ -d "main/InfusePlus.bundle" ]; then
            cp -r "main/InfusePlus.bundle" fake_deb/Library/MobileSubstrate/DynamicLibraries/
          fi
          
          # Create Control file for injection package
          mkdir -p fake_deb/DEBIAN
          cat > fake_deb/DEBIAN/control <<'DEBCTR'
          Package: com.infuseplus.fixed
          Name: InfusePlus Fixed
          Version: 1.0.0
          Architecture: iphoneos-arm64
          Maintainer: GitHub Actions
          Description: Injection Package
          Section: Tweaks
          DEBCTR

          # Build the injection DEB
          dpkg-deb -b fake_deb infuseplus_fixed.deb

          # 3. Inject using Cyan
          # Ensure cyan is in path
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "Running Cyan Injection..."
          cyan -i infuse.ipa \
               -o InfusePlus_Fixed.ipa \
               -u -w -e -f \
               --tweak infuseplus_fixed.deb \
               -n "${{ inputs.display_name }}" \
               -b "${{ inputs.bundle_id }}"

          if [ ! -f "InfusePlus_Fixed.ipa" ]; then
            echo "::error::Cyan failed to produce an output IPA."
            exit 1
          fi
          
          echo "::notice::IPA Created: InfusePlus_Fixed.ipa"

      - name: Upload Release
        if: ${{ inputs.ipa_url != '' }}
        uses: softprops/action-gh-release@v2
        with:
          name: "InfusePlus Fixed - iOS 26.2 (Build ${{ github.run_number }})"
          tag_name: "build-${{ github.run_number }}"
          files: InfusePlus_Fixed.ipa
          body: |
            ## InfusePlus (iOS 26.2 Compatible)
            
            **Build:** ${{ github.run_number }}
            **Bundle ID:** `${{ inputs.bundle_id }}`
            
            ### Improvements
            - Fixed `transitionDidFinish` crash
            - Fixed Black screen issues
            - Pro features unlocked
