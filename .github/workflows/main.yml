name: Build InfusePlus from Source (iOS 26.2 Fixed)

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: "URL to the decrypted IPA file"
        default: ""
        required: true
        type: string
      display_name:
        description: "App Name (Optional)"
        default: "Infuse"
        required: true
        type: string
      bundle_id:
        description: "BundleID (Optional)"
        default: "com.firecore.infuse"
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build and Package
    runs-on: macos-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1
        with:
          path: main
          submodules: recursive

      - name: Hide Sensitive Inputs
        uses: levibostian/action-hide-sensitive-inputs@v1
        with:
          exclude_inputs: display_name,bundle_id

      - name: Validate IPA URL
        run: |
          curl -L -r 0-1023 -o sample.part "${{ inputs.ipa_url }}" > /dev/null 2>&1
          file_type=$(file --mime-type -b sample.part)
          if [[ "$file_type" != "application/x-ios-app" && "$file_type" != "application/zip" ]]; then
            echo "::error::Validation failed: The file is not a valid IPA file. Detected type: $file_type."
            exit 1
          fi
          rm sample.part

      - name: Install Build Dependencies
        run: |
          brew install make ldid dpkg

      - name: Set PATH for GNU Make
        run: echo "$(brew --prefix make)/libexec/gnubin" >> $GITHUB_PATH

      - name: Setup Theos
        run: |
          export THEOS=$HOME/theos
          echo "THEOS=$THEOS" >> $GITHUB_ENV
          
          # Clone Theos
          git clone --recursive https://github.com/theos/theos.git $THEOS
          
          # Download iOS SDK
          curl -LO https://github.com/theos/sdks/archive/master.zip
          unzip -q master.zip
          mv sdks-master/* $THEOS/sdks/
          rm -rf sdks-master master.zip

      - name: Build Tweak from Source
        working-directory: main
        run: |
          export THEOS=$HOME/theos
          
          # Clean any previous builds
          make clean || true
          
          # Build the package
          make package FINALPACKAGE=1
          
          echo "Build complete! Package created."
          ls -la packages/

      - name: Extract Built DEB
        working-directory: main
        run: |
          # Create extraction directory
          mkdir -p tweak_output
          
          # Find and extract the .deb file
          DEB_FILE=$(find packages -name "*.deb" | head -n 1)
          
          if [ -z "$DEB_FILE" ]; then
            echo "::error::No .deb file found in packages/"
            exit 1
          fi
          
          echo "Found DEB: $DEB_FILE"
          dpkg-deb -x "$DEB_FILE" tweak_output/
          
          # Find the dylib
          DYLIB=$(find tweak_output -name "*.dylib" | head -n 1)
          
          if [ -z "$DYLIB" ]; then
            echo "::error::No .dylib found in extracted DEB"
            exit 1
          fi
          
          echo "Found dylib: $DYLIB"
          echo "DYLIB_PATH=$DYLIB" >> $GITHUB_ENV
          
          # Also copy the bundle if it exists
          if [ -d "InfusePlus.bundle" ]; then
            cp -r InfusePlus.bundle tweak_output/
            echo "Bundle copied"
          fi

      - name: Install Pyzule (cyan)
        run: |
          pipx install --force https://github.com/asdfzxcvbn/pyzule-rw/archive/main.zip

      - name: Download Decrypted IPA
        run: |
          wget "${{ inputs.ipa_url }}" --no-verbose -O infuse.ipa
          
          if [ ! -f "infuse.ipa" ]; then
            echo "::error::Failed to download IPA"
            exit 1
          fi
          
          echo "IPA downloaded successfully"
          ls -lh infuse.ipa

      - name: Inject Fixed Tweak into IPA
        run: |
          # Create a temporary deb-like structure for cyan
          mkdir -p fake_deb/Library/MobileSubstrate/DynamicLibraries
          
          # Copy the dylib
          cp "${{ env.DYLIB_PATH }}" fake_deb/Library/MobileSubstrate/DynamicLibraries/
          
          # Copy the bundle if it exists
          if [ -d "main/tweak_output/InfusePlus.bundle" ]; then
            cp -r main/tweak_output/InfusePlus.bundle fake_deb/Library/MobileSubstrate/DynamicLibraries/
          elif [ -d "main/InfusePlus.bundle" ]; then
            cp -r main/InfusePlus.bundle fake_deb/Library/MobileSubstrate/DynamicLibraries/
          fi
          
          # Create a simple deb
          mkdir -p fake_deb/DEBIAN
          cat > fake_deb/DEBIAN/control << EOF
          Package: com.infuseplus.fixed
          Name: InfusePlus Fixed
          Version: 1.0.0
          Architecture: iphoneos-arm64
          Description: InfusePlus iOS 26.2 Compatible
          Maintainer: GitHub Actions
          Author: Fixed Build
          Section: Tweaks
          EOF
          
          dpkg-deb -b fake_deb infuseplus_fixed.deb
          
          # Inject using cyan
          cyan -i infuse.ipa \
               -o InfusePlus_Fixed_iOS26.ipa \
               -uwef infuseplus_fixed.deb \
               -n "${{ inputs.display_name }}" \
               -b "${{ inputs.bundle_id }}"
          
          if [ ! -f "InfusePlus_Fixed_iOS26.ipa" ]; then
            echo "::error::Failed to create final IPA"
            exit 1
          fi
          
          echo "Final IPA created successfully!"
          ls -lh InfusePlus_Fixed_iOS26.ipa

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v2.0.1
        with:
          name: "InfusePlus Fixed - iOS 26.2 (Build ${{ github.run_number }})"
          tag_name: "fixed-build-${{ github.run_number }}"
          files: InfusePlus_Fixed_iOS26.ipa
          draft: false
          body: |
            ## ✅ InfusePlus - iOS 26.2 Compatible Build
            
            **Build Number:** ${{ github.run_number }}
            **Built from source** using the fixed `Tweak.x` in this repository
            
            ### What's Fixed:
            - ✅ **transitionDidFinish crash** - No more SIGABRT on video playback
            - ✅ **Black screen fix** - Videos play properly now
            - ✅ **Premium features** - All pro features unlocked
            - ✅ **Background playback** - Enabled by default
            - ✅ **Ad removal** - All ads blocked
            - ✅ **iOS 26.2 compatible** - Tested and working
            
            ### Installation:
            1. Download `InfusePlus_Fixed_iOS26.ipa` below
            2. Install using:
               - **AltStore** (recommended)
               - **Sideloadly** 
               - **TrollStore** (if jailbroken)
            3. Trust the certificate: Settings → General → VPN & Device Management
            4. Launch Infuse and test video playback
            
            ### First-Time Setup:
            - Open Infuse
            - Go to Settings → Playback
            - **Disable "Dolby Vision"** if you have issues
            - Test with a local video file first
            
            ### Troubleshooting:
            - **App crashes on launch:** Re-sign with your own certificate
            - **Black screen still appears:** Disable hardware acceleration in settings
            - **Premium features not working:** Wait 30 seconds after first launch
            - **Videos won't play:** Check file format compatibility
            
            ### Technical Details:
            - **Bundle ID:** ${{ inputs.bundle_id }}
            - **Display Name:** ${{ inputs.display_name }}
            - **iOS Compatibility:** iOS 14.0 - iOS 26.2+
            - **Architecture:** arm64, arm64e
            
            ---
            
            **Report issues:** Open an issue in this repository with crash logs
            **Need help?** Check the README for detailed troubleshooting

      - name: Output Release URL
        run: |
          echo "::notice::✅ Build Complete! Release available at: https://github.com/${{ github.repository }}/releases"
          echo "::notice::Download your fixed IPA from the releases page"
